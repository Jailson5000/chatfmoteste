# MiauChat - Guia de ProduÃ§Ã£o SaaS Multi-Tenant

## ğŸ“‹ Ãndice

1. [Diagramas de Arquitetura](#1-diagramas-de-arquitetura)
2. [Checklist de ProduÃ§Ã£o](#2-checklist-de-produÃ§Ã£o)
3. [Banco de Dados Multi-Tenant](#3-banco-de-dados-multi-tenant)
4. [AdaptaÃ§Ã£o por Stack](#4-adaptaÃ§Ã£o-por-stack)
5. [DocumentaÃ§Ã£o para Time TÃ©cnico](#5-documentaÃ§Ã£o-para-time-tÃ©cnico)

---

## 1. DIAGRAMAS DE ARQUITETURA

### 1.1 VisÃ£o Geral â€“ SaaS Multi-Tenant

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USUÃRIO                                      â”‚
â”‚                     empresa.miauchat.com.br                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DNS WILDCARD                                      â”‚
â”‚                   *.miauchat.com.br â†’ IP                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT APP (React)                                   â”‚
â”‚                    Projeto do Cliente SaaS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TENANT RESOLVER                                     â”‚
â”‚                                                                           â”‚
â”‚   1. Extrai subdomÃ­nio da URL                                            â”‚
â”‚      hostname = "empresa.miauchat.com.br"                                â”‚
â”‚      subdomain = "empresa"                                               â”‚
â”‚                                                                           â”‚
â”‚   2. Consulta banco de dados                                             â”‚
â”‚      SELECT * FROM law_firms WHERE subdomain = 'empresa'                 â”‚
â”‚                                                                           â”‚
â”‚   3. Define tenant_id no contexto                                        â”‚
â”‚      TenantContext.tenant.id = law_firm_id                               â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CAMADA DE SERVIÃ‡OS                                   â”‚
â”‚                                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  Conversas  â”‚  â”‚   Kanban    â”‚  â”‚  Contatos   â”‚  â”‚  AutomaÃ§Ãµes â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚          â”‚                â”‚                â”‚                â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                   â”‚                                       â”‚
â”‚                      law_firm_id = tenant.id                             â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BANCO DE DADOS MULTI-TENANT                            â”‚
â”‚                         (Supabase/PostgreSQL)                             â”‚
â”‚                                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                   ROW LEVEL SECURITY (RLS)                       â”‚    â”‚
â”‚   â”‚                                                                  â”‚    â”‚
â”‚   â”‚   Todas as queries sÃ£o automaticamente filtradas por:           â”‚    â”‚
â”‚   â”‚   law_firm_id = get_user_law_firm_id(auth.uid())                â”‚    â”‚
â”‚   â”‚                                                                  â”‚    â”‚
â”‚   â”‚   âœ“ Isolamento garantido no nÃ­vel do banco                      â”‚    â”‚
â”‚   â”‚   âœ“ UsuÃ¡rio nunca acessa dados de outro tenant                  â”‚    â”‚
â”‚   â”‚   âœ“ Admin sÃ³ acessa seus dados                                  â”‚    â”‚
â”‚   â”‚                                                                  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 SeparaÃ§Ã£o Cliente Ã— Admin

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INFRAESTRUTURA MIAUCHAT                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          ADMIN APP                 â”‚
                    â”‚    (Painel Administrativo)         â”‚
                    â”‚                                    â”‚
                    â”‚   URL: global-admin/*              â”‚
                    â”‚                                    â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚   â”‚ FunÃ§Ãµes:                  â”‚   â”‚
                    â”‚   â”‚ â€¢ GestÃ£o de Empresas      â”‚   â”‚
                    â”‚   â”‚ â€¢ GestÃ£o de Planos        â”‚   â”‚
                    â”‚   â”‚ â€¢ Monitoramento Global    â”‚   â”‚
                    â”‚   â”‚ â€¢ ConfiguraÃ§Ãµes Sistema   â”‚   â”‚
                    â”‚   â”‚ â€¢ UsuÃ¡rios Admin          â”‚   â”‚
                    â”‚   â”‚ â€¢ Logs de Auditoria       â”‚   â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                                    â”‚
                    â”‚   Roles:                           â”‚
                    â”‚   â€¢ super_admin                    â”‚
                    â”‚   â€¢ admin_operacional              â”‚
                    â”‚   â€¢ admin_financeiro               â”‚
                    â”‚                                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ GestÃ£o Global
                                     â”‚ (CRUD Empresas)
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SERVIÃ‡OS / APIs (Multi-Tenant)                      â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ Edge Functions  â”‚  â”‚ Supabase Auth   â”‚  â”‚ Supabase DB     â”‚           â”‚
â”‚   â”‚ â€¢ provision-co  â”‚  â”‚ â€¢ Login tenant  â”‚  â”‚ â€¢ RLS policies  â”‚           â”‚
â”‚   â”‚ â€¢ evolution-*   â”‚  â”‚ â€¢ Login admin   â”‚  â”‚ â€¢ Isolamento    â”‚           â”‚
â”‚   â”‚ â€¢ sync-n8n-*    â”‚  â”‚ â€¢ Signup        â”‚  â”‚ â€¢ Ãndices       â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â–²
                                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                          â”‚                          â”‚
          â”‚                          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLIENT APP     â”‚     â”‚    CLIENT APP     â”‚     â”‚    CLIENT APP     â”‚
â”‚    (Empresa A)    â”‚     â”‚    (Empresa B)    â”‚     â”‚    (Empresa C)    â”‚
â”‚                   â”‚     â”‚                   â”‚     â”‚                   â”‚
â”‚ empresaa.miauchat â”‚     â”‚ empresab.miauchat â”‚     â”‚ empresac.miauchat â”‚
â”‚    .com.br        â”‚     â”‚    .com.br        â”‚     â”‚    .com.br        â”‚
â”‚                   â”‚     â”‚                   â”‚     â”‚                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Conversas     â”‚ â”‚     â”‚ â”‚ Conversas     â”‚ â”‚     â”‚ â”‚ Conversas     â”‚ â”‚
â”‚ â”‚ Kanban        â”‚ â”‚     â”‚ â”‚ Kanban        â”‚ â”‚     â”‚ â”‚ Kanban        â”‚ â”‚
â”‚ â”‚ Contatos      â”‚ â”‚     â”‚ â”‚ Contatos      â”‚ â”‚     â”‚ â”‚ Contatos      â”‚ â”‚
â”‚ â”‚ AutomaÃ§Ãµes IA â”‚ â”‚     â”‚ â”‚ AutomaÃ§Ãµes IA â”‚ â”‚     â”‚ â”‚ AutomaÃ§Ãµes IA â”‚ â”‚
â”‚ â”‚ ConfiguraÃ§Ãµes â”‚ â”‚     â”‚ â”‚ ConfiguraÃ§Ãµes â”‚ â”‚     â”‚ â”‚ ConfiguraÃ§Ãµes â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â”‚     â”‚                   â”‚     â”‚                   â”‚
â”‚ Roles:            â”‚     â”‚ Roles:            â”‚     â”‚ Roles:            â”‚
â”‚ â€¢ admin           â”‚     â”‚ â€¢ admin           â”‚     â”‚ â€¢ admin           â”‚
â”‚ â€¢ advogado        â”‚     â”‚ â€¢ advogado        â”‚     â”‚ â€¢ advogado        â”‚
â”‚ â€¢ estagiario      â”‚     â”‚ â€¢ estagiario      â”‚     â”‚ â€¢ estagiario      â”‚
â”‚ â€¢ atendente       â”‚     â”‚ â€¢ atendente       â”‚     â”‚ â€¢ atendente       â”‚
â”‚                   â”‚     â”‚                   â”‚     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â–²                         â–²                         â–²
        â”‚                         â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    ISOLAMENTO TOTAL       â”‚
                    â”‚                           â”‚
                    â”‚ â€¢ Dados segregados        â”‚
                    â”‚ â€¢ UsuÃ¡rios isolados       â”‚
                    â”‚ â€¢ ConfiguraÃ§Ãµes prÃ³prias  â”‚
                    â”‚ â€¢ Branding customizado    â”‚
                    â”‚                           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Fluxo de CriaÃ§Ã£o de Cliente

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUXO DE ONBOARDING DE CLIENTE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ADMIN                       SISTEMA                         BANCO
      â”‚                            â”‚                              â”‚
      â”‚  1. Acessa Global Admin    â”‚                              â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                              â”‚
      â”‚                            â”‚                              â”‚
      â”‚  2. Clica "Nova Empresa"   â”‚                              â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                              â”‚
      â”‚                            â”‚                              â”‚
      â”‚  3. Preenche dados:        â”‚                              â”‚
      â”‚     â€¢ Nome da empresa      â”‚                              â”‚
      â”‚     â€¢ Email contato        â”‚                              â”‚
      â”‚     â€¢ Plano escolhido      â”‚                              â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                              â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  4. Gera subdomÃ­nio          â”‚
      â”‚                            â”‚  "Empresa X" â†’ "empresa-x"   â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  5. Verifica disponibilidade â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                            â”‚  âœ“ DisponÃ­vel                â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  6. Chama provision-company  â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  7. Cria law_firm            â”‚
      â”‚                            â”‚  INSERT INTO law_firms       â”‚
      â”‚                            â”‚  (name, subdomain, email)    â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  8. Cria company             â”‚
      â”‚                            â”‚  INSERT INTO companies       â”‚
      â”‚                            â”‚  (name, law_firm_id, plan_id)â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  9. Cria automaÃ§Ã£o padrÃ£o    â”‚
      â”‚                            â”‚  INSERT INTO automations     â”‚
      â”‚                            â”‚  (name, law_firm_id, ...)    â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                            â”‚                              â”‚
      â”‚                            â”‚  10. Notifica n8n            â”‚
      â”‚                            â”‚  POST â†’ N8N_WEBHOOK_URL      â”‚
      â”‚                            â”‚â”€â”€â”€â”€â”€â”€> [Webhook Externo]     â”‚
      â”‚                            â”‚                              â”‚
      â”‚  11. Retorna sucesso       â”‚                              â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
      â”‚                            â”‚                              â”‚
      â”‚  12. Exibe subdomÃ­nio      â”‚                              â”‚
      â”‚  empresa-x.miauchat.com.br â”‚                              â”‚
      â”‚                            â”‚                              â”‚
      â–¼                            â–¼                              â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT APP ATIVO                                  â”‚
â”‚                                                                          â”‚
â”‚   URL: empresa-x.miauchat.com.br                                        â”‚
â”‚                                                                          â”‚
â”‚   PrÃ³ximos passos:                                                      â”‚
â”‚   â€¢ Criar primeiro usuÃ¡rio admin                                        â”‚
â”‚   â€¢ Configurar WhatsApp                                                 â”‚
â”‚   â€¢ Upload de logo                                                      â”‚
â”‚   â€¢ Configurar agentes IA                                               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 Fluxo de AutenticaÃ§Ã£o por Tenant

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLUXO DE LOGIN POR SUBDOMÃNIO                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    USUÃRIO                     FRONTEND                       BACKEND
       â”‚                           â”‚                              â”‚
       â”‚  1. Acessa subdomÃ­nio     â”‚                              â”‚
       â”‚  empresa.miauchat.com.br  â”‚                              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                              â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚  2. TenantProvider           â”‚
       â”‚                           â”‚  Extrai subdomÃ­nio           â”‚
       â”‚                           â”‚  subdomain = "empresa"       â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚  3. Busca tenant             â”‚
       â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                           â”‚  SELECT * FROM law_firms     â”‚
       â”‚                           â”‚  WHERE subdomain = 'empresa' â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                           â”‚  tenant = { id, name, ... }  â”‚
       â”‚                           â”‚                              â”‚
       â”‚  4. Exibe tela de login   â”‚                              â”‚
       â”‚  com branding do tenant   â”‚                              â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
       â”‚                           â”‚                              â”‚
       â”‚  5. Envia credenciais     â”‚                              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                              â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚  6. Autentica                â”‚
       â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                           â”‚  supabase.auth.signIn(...)   â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                           â”‚  { user, session }           â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚  7. Valida pertencimento     â”‚
       â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                           â”‚  SELECT * FROM profiles      â”‚
       â”‚                           â”‚  WHERE id = user.id          â”‚
       â”‚                           â”‚                              â”‚
       â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                           â”‚  profile.law_firm_id ==      â”‚
       â”‚                           â”‚  tenant.id ? âœ“ : âœ—           â”‚
       â”‚                           â”‚                              â”‚
       â”‚  8. Acesso liberado       â”‚                              â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
       â”‚                           â”‚                              â”‚
       â”‚  Dashboard com dados      â”‚                              â”‚
       â”‚  filtrados por tenant     â”‚                              â”‚
       â”‚                           â”‚                              â”‚
       â–¼                           â–¼                              â–¼
```

---

## 2. CHECKLIST DE PRODUÃ‡ÃƒO

### 2.1 Arquitetura & Infraestrutura

| Item | Status | DescriÃ§Ã£o |
|------|--------|-----------|
| âœ… | Implementado | Client App separado do Admin App |
| âœ… | Implementado | IdentificaÃ§Ã£o de tenant por subdomÃ­nio |
| â³ | Pendente | DNS wildcard configurado (*.miauchat.com.br) |
| â³ | Pendente | HTTPS com SSL wildcard |
| â³ | Pendente | Load balancer (se aplicÃ¡vel) |
| â³ | Pendente | CDN para assets estÃ¡ticos |

### 2.2 SeguranÃ§a

| Item | Status | DescriÃ§Ã£o |
|------|--------|-----------|
| âœ… | Implementado | RBAC implementado (admin, advogado, estagiario, atendente) |
| âœ… | Implementado | Isolamento de dados por tenant (RLS) |
| â³ | Pendente | Rate limit por tenant |
| âœ… | Implementado | Logs segregados (audit_logs) |
| âœ… | Implementado | Auditoria administrativa |
| âœ… | Implementado | PolÃ­ticas RLS em todas as tabelas |
| âœ… | Implementado | FunÃ§Ãµes SECURITY DEFINER |

### 2.3 Banco de Dados

| Item | Status | DescriÃ§Ã£o |
|------|--------|-----------|
| âœ… | Implementado | Modelo multi-tenant definido (law_firm_id) |
| âœ… | Implementado | Ãndices por law_firm_id |
| âœ… | Implementado | MigraÃ§Ãµes versionadas |
| â³ | Pendente | Backup automatizado |
| â³ | Pendente | Restore testado |
| âœ… | Implementado | FunÃ§Ãµes de lookup (get_user_law_firm_id, etc.) |

### 2.4 SaaS & Escala

| Item | Status | DescriÃ§Ã£o |
|------|--------|-----------|
| âœ… | Implementado | CriaÃ§Ã£o automÃ¡tica de tenant (provision-company) |
| âœ… | Implementado | Status de empresa (active, suspended, trial) |
| â³ | Pendente | SuspensÃ£o automÃ¡tica por inadimplÃªncia |
| â³ | Pendente | Monitoramento por empresa |
| âœ… | Implementado | Estrutura de planos (plans table) |
| â³ | Pendente | IntegraÃ§Ã£o com gateway de pagamento |
| â³ | Pendente | Observabilidade (logs + mÃ©tricas centralizadas) |

### 2.5 Onboarding

| Item | Status | DescriÃ§Ã£o |
|------|--------|-----------|
| âœ… | Implementado | GeraÃ§Ã£o automÃ¡tica de subdomÃ­nio |
| âœ… | Implementado | VerificaÃ§Ã£o de disponibilidade |
| âœ… | Implementado | Edge function de provisionamento |
| â³ | Pendente | Wizard de configuraÃ§Ã£o inicial |
| â³ | Pendente | CriaÃ§Ã£o de primeiro usuÃ¡rio admin via invite |
| â³ | Pendente | PÃ¡gina de tenant nÃ£o encontrado |

---

## 3. BANCO DE DADOS MULTI-TENANT

### 3.1 Modelo Adotado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODELO: MULTI-TENANT POR law_firm_id                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Todas as tabelas de dados do cliente contÃªm a coluna:

    law_firm_id UUID NOT NULL REFERENCES law_firms(id)

O isolamento Ã© garantido por:

1. ROW LEVEL SECURITY (RLS) - NÃ­vel de banco
2. TENANT CONTEXT - NÃ­vel de aplicaÃ§Ã£o
3. VALIDAÃ‡ÃƒO EM QUERIES - NÃ­vel de hooks
```

### 3.2 Diagrama de Tabelas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TABELAS GLOBAIS                                 â”‚
â”‚                    (Gerenciadas pelo Admin App)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   admin_profiles â”‚     â”‚ admin_user_roles â”‚     â”‚      plans       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚     â”‚ id               â”‚     â”‚ id               â”‚
â”‚ user_id          â”‚     â”‚ user_id          â”‚     â”‚ name             â”‚
â”‚ full_name        â”‚     â”‚ role (enum)      â”‚     â”‚ price            â”‚
â”‚ email            â”‚     â”‚ created_at       â”‚     â”‚ features (jsonb) â”‚
â”‚ is_active        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ max_users        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ max_instances    â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  system_settings â”‚     â”‚   system_metrics â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚     â”‚ id               â”‚
â”‚ key              â”‚     â”‚ metric_name      â”‚
â”‚ value (jsonb)    â”‚     â”‚ metric_value     â”‚
â”‚ category         â”‚     â”‚ recorded_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TABELAS MULTI-TENANT                               â”‚
â”‚                   (Filtradas por law_firm_id)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    law_firms     â”‚â”€â”€â”€â”€>â”‚    companies     â”‚     â”‚    profiles      â”‚
â”‚   (Tenants)      â”‚     â”‚  (GestÃ£o SaaS)   â”‚     â”‚  (UsuÃ¡rios)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id               â”‚     â”‚ id               â”‚     â”‚ id               â”‚
â”‚ name             â”‚     â”‚ name             â”‚     â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”
â”‚ subdomain (uniq) â”‚     â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”‚ full_name        â”‚ â”‚
â”‚ email            â”‚     â”‚ plan_id          â”‚     â”‚ email            â”‚ â”‚
â”‚ logo_url         â”‚     â”‚ status           â”‚     â”‚ role (via join)  â”‚ â”‚
â”‚ created_at       â”‚     â”‚ trial_ends_at    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
        â”‚                                                               â”‚
        â”‚                                                               â”‚
        â–¼                                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    clients       â”‚     â”‚  conversations   â”‚     â”‚    messages      â”‚ â”‚
â”‚  (Contatos)      â”‚     â”‚  (Conversas)     â”‚     â”‚  (Mensagens)     â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ id               â”‚     â”‚ id               â”‚     â”‚ id               â”‚ â”‚
â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”‚ conversation_id  â”‚ â”‚
â”‚ name             â”‚     â”‚ client_id        â”‚     â”‚ content          â”‚ â”‚
â”‚ phone            â”‚     â”‚ remote_jid       â”‚     â”‚ sender_type      â”‚ â”‚
â”‚ email            â”‚     â”‚ status           â”‚     â”‚ is_from_me       â”‚ â”‚
â”‚ custom_status_id â”‚     â”‚ assigned_to      â”‚     â”‚ media_url        â”‚ â”‚
â”‚ department_id    â”‚     â”‚ department_id    â”‚     â”‚ created_at       â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   automations    â”‚     â”‚ knowledge_items  â”‚     â”‚ whatsapp_insts   â”‚ â”‚
â”‚   (Agentes IA)   â”‚     â”‚ (Base Conhec.)   â”‚     â”‚ (ConexÃµes WA)    â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ id               â”‚     â”‚ id               â”‚     â”‚ id               â”‚ â”‚
â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”‚ law_firm_id   â—„â”€â”€â”¼â”€â”˜
â”‚ name             â”‚     â”‚ title            â”‚     â”‚ instance_name    â”‚
â”‚ ai_prompt        â”‚     â”‚ content          â”‚     â”‚ phone_number     â”‚
â”‚ webhook_url      â”‚     â”‚ category         â”‚     â”‚ status           â”‚
â”‚ is_active        â”‚     â”‚ item_type        â”‚     â”‚ api_url          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 PolÃ­ticas RLS (Row Level Security)

```sql
-- =====================================================================
-- PADRÃƒO DE RLS PARA TABELAS MULTI-TENANT
-- =====================================================================

-- 1. Habilitar RLS na tabela
ALTER TABLE public.nome_tabela ENABLE ROW LEVEL SECURITY;

-- 2. PolÃ­tica de SELECT (leitura)
CREATE POLICY "Users can view records in their law firm"
ON public.nome_tabela
FOR SELECT
USING (law_firm_id = get_user_law_firm_id(auth.uid()));

-- 3. PolÃ­tica de INSERT (criaÃ§Ã£o)
CREATE POLICY "Users can insert records in their law firm"
ON public.nome_tabela
FOR INSERT
WITH CHECK (law_firm_id = get_user_law_firm_id(auth.uid()));

-- 4. PolÃ­tica de UPDATE (atualizaÃ§Ã£o) - restrito a admins
CREATE POLICY "Admins can update records in their law firm"
ON public.nome_tabela
FOR UPDATE
USING (
  law_firm_id = get_user_law_firm_id(auth.uid()) 
  AND has_role(auth.uid(), 'admin')
);

-- 5. PolÃ­tica de DELETE (exclusÃ£o) - restrito a admins
CREATE POLICY "Admins can delete records in their law firm"
ON public.nome_tabela
FOR DELETE
USING (
  law_firm_id = get_user_law_firm_id(auth.uid()) 
  AND has_role(auth.uid(), 'admin')
);
```

### 3.4 FunÃ§Ãµes de SeguranÃ§a

```sql
-- =====================================================================
-- FUNÃ‡Ã•ES SECURITY DEFINER (Evitam recursÃ£o infinita em RLS)
-- =====================================================================

-- Obter law_firm_id do usuÃ¡rio logado
CREATE FUNCTION get_user_law_firm_id(_user_id UUID)
RETURNS UUID
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT law_firm_id FROM profiles WHERE id = _user_id
$$;

-- Verificar se usuÃ¡rio tem determinada role
CREATE FUNCTION has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = _user_id AND role = _role
  )
$$;

-- Verificar se Ã© admin global
CREATE FUNCTION is_admin(_user_id UUID)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM admin_user_roles WHERE user_id = _user_id
  )
$$;

-- Buscar tenant por subdomÃ­nio
CREATE FUNCTION get_law_firm_by_subdomain(_subdomain TEXT)
RETURNS UUID
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT id FROM law_firms WHERE subdomain = _subdomain
$$;
```

### 3.5 Ãndices Recomendados

```sql
-- =====================================================================
-- ÃNDICES PARA PERFORMANCE MULTI-TENANT
-- =====================================================================

-- Ãndice principal por tenant (todas as tabelas com law_firm_id)
CREATE INDEX idx_clients_law_firm_id ON clients(law_firm_id);
CREATE INDEX idx_conversations_law_firm_id ON conversations(law_firm_id);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_automations_law_firm_id ON automations(law_firm_id);
CREATE INDEX idx_templates_law_firm_id ON templates(law_firm_id);
CREATE INDEX idx_tags_law_firm_id ON tags(law_firm_id);
CREATE INDEX idx_departments_law_firm_id ON departments(law_firm_id);
CREATE INDEX idx_custom_statuses_law_firm_id ON custom_statuses(law_firm_id);
CREATE INDEX idx_knowledge_items_law_firm_id ON knowledge_items(law_firm_id);
CREATE INDEX idx_whatsapp_instances_law_firm_id ON whatsapp_instances(law_firm_id);

-- Ãndice para lookup de subdomÃ­nio
CREATE UNIQUE INDEX idx_law_firms_subdomain ON law_firms(subdomain);

-- Ãndice para busca de perfil por usuÃ¡rio
CREATE INDEX idx_profiles_id_law_firm_id ON profiles(id, law_firm_id);

-- Ãndice para roles
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
```

---

## 4. ADAPTAÃ‡ÃƒO POR STACK

### 4.1 Supabase (Stack Atual) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STACK SUPABASE                                  â”‚
â”‚                        (ImplementaÃ§Ã£o Atual)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FRONTEND      â”‚
â”‚    (React)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Lovable        â”‚
â”‚ â€¢ React + Vite   â”‚
â”‚ â€¢ TailwindCSS    â”‚
â”‚ â€¢ TanStack Query â”‚
â”‚ â€¢ React Router   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUPABASE AUTH   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Email/Password â”‚
â”‚ â€¢ Auto-confirm   â”‚
â”‚ â€¢ SessÃµes JWT    â”‚
â”‚ â€¢ Refresh tokens â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUPABASE DB     â”‚     â”‚  EDGE FUNCTIONS  â”‚
â”‚  (PostgreSQL)    â”‚     â”‚  (Deno)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ RLS policies   â”‚     â”‚ â€¢ provision-co   â”‚
â”‚ â€¢ Functions      â”‚     â”‚ â€¢ evolution-api  â”‚
â”‚ â€¢ Triggers       â”‚     â”‚ â€¢ sync-n8n       â”‚
â”‚ â€¢ Realtime       â”‚     â”‚ â€¢ transcribe     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ConfiguraÃ§Ã£o Multi-Tenant:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ RLS com law_firm_id
âœ“ FunÃ§Ãµes SECURITY DEFINER
âœ“ PolÃ­ticas por role
âœ“ Realtime por tenant
```

### 4.2 AWS (Alternativa Enterprise)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            STACK AWS                                     â”‚
â”‚                     (Para Escala Enterprise)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Route53 (DNS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*.miauchat.com.br â†’ ALB

ALB (Load Balancer)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ SSL Termination (ACM)
â€¢ Health Checks
â€¢ Target Groups

ECS / EKS
â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Containers Docker
â€¢ Auto-scaling
â€¢ Multi-AZ

RDS PostgreSQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Multi-AZ
â€¢ Read Replicas
â€¢ Automated Backups
â€¢ RLS polÃ­ticas

ServiÃ§os Adicionais:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CloudWatch (Logs/MÃ©tricas)
â€¢ S3 (Armazenamento)
â€¢ SES (Email)
â€¢ Lambda (Serverless)
â€¢ ElastiCache (Redis)
```

### 4.3 Vercel (Alternativa Simples)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STACK VERCEL                                    â”‚
â”‚                    (Para Deploy Simplificado)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Domain Wildcard
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*.miauchat.com.br â†’ Vercel

Middleware (Edge)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Resolve subdomÃ­nio
â€¢ Rewrite para app

Serverless Functions
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ API Routes
â€¢ Edge Functions

Supabase (Backend)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Database
â€¢ Auth
â€¢ Storage
```

### 4.4 Firebase (Alternativa Google)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STACK FIREBASE                                   â”‚
â”‚                      (Ecossistema Google)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Firebase Hosting
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Wildcard domain
â€¢ CDN global

Firebase Auth
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Multi-tenant
â€¢ Custom claims

Firestore
â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ tenant_id em docs
â€¢ Security Rules

Cloud Functions
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Resolver tenant
â€¢ Background tasks
```

---

## 5. DOCUMENTAÃ‡ÃƒO PARA TIME TÃ‰CNICO

### 5.1 VisÃ£o Geral do Projeto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MIAUCHAT                                        â”‚
â”‚           Multiplataforma de InteligÃªncia Artificial Unificada           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Projeto dividido em:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. CLIENT APP
   â€¢ Produto usado pelos clientes (escritÃ³rios)
   â€¢ Acesso via subdomÃ­nio: empresa.miauchat.com.br
   â€¢ Features: Conversas, Kanban, Contatos, AutomaÃ§Ãµes IA

2. ADMIN APP
   â€¢ Painel administrativo global
   â€¢ Acesso via: /global-admin/*
   â€¢ Features: GestÃ£o de empresas, planos, monitoramento

Modelo: SaaS Multi-Tenant
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Um banco de dados compartilhado
â€¢ Dados isolados por law_firm_id
â€¢ RLS garante isolamento
â€¢ SubdomÃ­nio identifica tenant
```

### 5.2 Regras de Desenvolvimento

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REGRAS OBRIGATÃ“RIAS                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… FAÃ‡A:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Sempre resolver tenant antes de qualquer aÃ§Ã£o
â€¢ Incluir law_firm_id em todas as queries
â€¢ Usar hooks existentes (useTenant, useLawFirm)
â€¢ Testar isolamento entre tenants
â€¢ Usar funÃ§Ãµes SECURITY DEFINER para evitar recursÃ£o RLS
â€¢ Criar RLS em novas tabelas

âŒ NÃƒO FAÃ‡A:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Misturar lÃ³gica Admin com Client
â€¢ Fazer queries sem filtro de tenant
â€¢ Acessar auth.users diretamente
â€¢ Confiar apenas no frontend para isolamento
â€¢ Expor dados de outros tenants
â€¢ Criar tabelas sem RLS
```

### 5.3 Fluxos CrÃ­ticos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FLUXOS CRÃTICOS                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. CRIAÃ‡ÃƒO DE EMPRESA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Admin App â†’ provision-company â†’ law_firms + companies + automation
   
   Arquivos:
   â€¢ supabase/functions/provision-company/index.ts
   â€¢ src/hooks/useCompanies.tsx
   â€¢ src/pages/global-admin/GlobalAdminCompanies.tsx

2. PROVISIONAMENTO AUTOMÃTICO
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Edge Function â†’ Cria estrutura â†’ Notifica n8n
   
   Arquivos:
   â€¢ supabase/functions/provision-company/index.ts

3. LOGIN POR SUBDOMÃNIO
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TenantProvider â†’ Detecta subdomain â†’ Carrega tenant â†’ Auth
   
   Arquivos:
   â€¢ src/hooks/useTenant.tsx
   â€¢ src/pages/Auth.tsx
   â€¢ src/hooks/useAuth.tsx

4. SUSPENSÃƒO DE TENANT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Admin â†’ Atualiza status â†’ Bloqueia acesso
   
   Tabelas:
   â€¢ companies.status = 'suspended'

5. AUDITORIA ADMINISTRATIVA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   AÃ§Ã£o â†’ audit_logs â†’ Registro completo
   
   Tabela:
   â€¢ audit_logs (action, entity_type, old_values, new_values)
```

### 5.4 PadrÃµes ObrigatÃ³rios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PADRÃ•ES DE CÃ“DIGO                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. RBAC (Role-Based Access Control)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // Verificar role antes de aÃ§Ãµes sensÃ­veis
   const { hasRole } = useUserRole();
   if (!hasRole('admin')) return <AccessDenied />;

2. MIDDLEWARE DE TENANT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // Sempre usar useTenant() para obter contexto
   const { tenant, isLoading } = useTenant();
   if (isLoading) return <Loading />;
   if (!tenant) return <TenantNotFound />;

3. LOGS ESTRUTURADOS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // Incluir tenant_id em logs
   console.log('[Tenant:${tenant.id}] AÃ§Ã£o executada');

4. QUERIES COM TENANT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // SEMPRE filtrar por law_firm_id
   const { data } = await supabase
     .from('clients')
     .select('*')
     .eq('law_firm_id', tenant.id);

5. RLS EM NOVAS TABELAS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // Toda nova tabela DEVE ter:
   // - Coluna law_firm_id
   // - RLS habilitado
   // - PolÃ­ticas por role
```

### 5.5 Estrutura de Arquivos

```
miauchat/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ MULTI-TENANT-ARCHITECTURE.md    # Arquitetura de subdomÃ­nios
â”‚   â”œâ”€â”€ SAAS-PRODUCTION-GUIDE.md        # Este documento
â”‚   â””â”€â”€ CLIENT-VS-ADMIN-SEPARATION.md   # SeparaÃ§Ã£o de apps
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ auth/                       # ProteÃ§Ã£o de rotas
â”‚   â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ AdminRoute.tsx
â”‚   â”‚   â”‚   â””â”€â”€ GlobalAdminRoute.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppLayout.tsx           # Layout Client App
â”‚   â”‚   â”‚   â”œâ”€â”€ AppSidebar.tsx          # Sidebar Client
â”‚   â”‚   â”‚   â””â”€â”€ GlobalAdminLayout.tsx   # Layout Admin App
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ global-admin/               # Componentes Admin
â”‚   â”‚       â””â”€â”€ DomainConfigDialog.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useTenant.tsx              # â­ Contexto de tenant
â”‚   â”‚   â”œâ”€â”€ useLawFirm.tsx             # Dados do escritÃ³rio
â”‚   â”‚   â”œâ”€â”€ useAuth.tsx                # AutenticaÃ§Ã£o client
â”‚   â”‚   â”œâ”€â”€ useAdminAuth.tsx           # AutenticaÃ§Ã£o admin
â”‚   â”‚   â””â”€â”€ useUserRole.tsx            # VerificaÃ§Ã£o de roles
â”‚   â”‚
â”‚   â””â”€â”€ pages/
â”‚       â”œâ”€â”€ Auth.tsx                    # Login Client
â”‚       â”œâ”€â”€ Dashboard.tsx               # Dashboard Client
â”‚       â”‚
â”‚       â””â”€â”€ global-admin/               # PÃ¡ginas Admin
â”‚           â”œâ”€â”€ GlobalAdminAuth.tsx
â”‚           â”œâ”€â”€ GlobalAdminDashboard.tsx
â”‚           â”œâ”€â”€ GlobalAdminCompanies.tsx
â”‚           â””â”€â”€ ...
â”‚
â””â”€â”€ supabase/
    â””â”€â”€ functions/
        â”œâ”€â”€ provision-company/          # CriaÃ§Ã£o de tenant
        â”œâ”€â”€ evolution-api/              # API WhatsApp
        â”œâ”€â”€ evolution-webhook/          # Webhooks WhatsApp
        â””â”€â”€ sync-n8n-prompt/            # Sync com n8n
```

---

## ğŸ“ Contato

Para dÃºvidas sobre a implementaÃ§Ã£o, entre em contato com a equipe tÃ©cnica.

**DocumentaÃ§Ã£o atualizada em:** Dezembro 2024
